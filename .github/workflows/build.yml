name: Bundle Metamod + CounterStrikeSharp + PoorSharpTimer (Linux & Windows)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

permissions:
  contents: write

env:
  # Linux sources
  METAMOD_URL_LINUX: https://mms.alliedmods.net/mmsdrop/2.0/mmsource-2.0.0-git1366-linux.tar.gz
  CSS_URL_LINUX: https://github.com/roflmuffin/CounterStrikeSharp/releases/download/v1.0.340/counterstrikesharp-with-runtime-linux-1.0.340.zip
  STFIXES_LINUX: https://github.com/SharpTimer/STFixes-metamod/releases/download/9-23/stfixes-metamod-9-23-linux.zip
  MOVUNLOCKER_LINUX: https://github.com/Source2ZE/MovementUnlocker/releases/download/v1.8/MovementUnlocker-v1.8-linux.tar.gz
  RAMPBUGFIX_LINUX: https://github.com/Interesting-exe/CS2Fixes-RampbugFix/releases/download/9-16/CS2Fixes-RampbugFix-9-16-linux.zip

  # Windows sources
  METAMOD_URL_WINDOWS: https://mms.alliedmods.net/mmsdrop/2.0/mmsource-2.0.0-git1366-windows.zip
  CSS_URL_WINDOWS: https://github.com/roflmuffin/CounterStrikeSharp/releases/download/v1.0.340/counterstrikesharp-with-runtime-windows-1.0.340.zip
  STFIXES_WINDOWS: https://github.com/SharpTimer/STFixes-metamod/releases/download/9-23/stfixes-metamod-9-23-windows.zip
  MOVUNLOCKER_WINDOWS: https://github.com/Source2ZE/MovementUnlocker/releases/download/v1.8/MovementUnlocker-v1.8-windows.zip
  RAMPBUGFIX_WINDOWS: https://github.com/Interesting-exe/CS2Fixes-RampbugFix/releases/download/9-16/CS2Fixes-RampbugFix-9-16-windows.zip

  # Common extras
  CS2_TAGS: https://github.com/schwarper/cs2-tags/releases/download/v1.15/cs2-tags-v1.15.zip
  PST_REPO: https://github.com/Letaryat/poor-sharptimer.git
  PST_BRANCH: dev

  # Output names
  OUT_LINUX: bundle_linux
  OUT_WINDOWS: bundle_windows
  ZIP_LINUX: sharptimer-drop-in-linux.zip
  ZIP_WINDOWS: sharptimer-drop-in-windows.zip

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (optional)
        uses: actions/checkout@v4

      - name: Prep environment
        run: |
          sudo apt-get update -y
          sudo apt-get install -y unzip zip git
          rm -rf "$OUT_LINUX" "$OUT_WINDOWS" pst
          mkdir -p "$OUT_LINUX" "$OUT_WINDOWS"

      # --------------------- LINUX BUNDLE ---------------------
      - name: Download Metamod (Linux)
        run: curl -L "$METAMOD_URL_LINUX" -o mms_linux.tar.gz

      - name: Extract Metamod (Linux) into addons/metamod/
        run: tar -xzf mms_linux.tar.gz -C "$OUT_LINUX"

      - name: Download CounterStrikeSharp (Linux)
        run: curl -L "$CSS_URL_LINUX" -o css_linux.zip

      - name: Extract CounterStrikeSharp (Linux)
        run: unzip -q css_linux.zip -d "$OUT_LINUX"

      - name: Download STFixes (Linux)
        run: curl -L "$STFIXES_LINUX" -o stfixes_linux.zip

      - name: Extract STFixes (Linux)
        run: unzip -q stfixes_linux.zip -d "$OUT_LINUX"

      - name: Download MovementUnlocker (Linux)
        run: curl -L "$MOVUNLOCKER_LINUX" -o mu_linux.tar.gz

      - name: Extract MovementUnlocker (Linux)
        run: tar -xzf mu_linux.tar.gz -C "$OUT_LINUX"

      - name: Download RampBugFix (Linux)
        run: curl -L "$RAMPBUGFIX_LINUX" -o ramp_linux.zip

      - name: Extract RampBugFix (Linux)
        run: unzip -q ramp_linux.zip -d "$OUT_LINUX"

      - name: Download CS2-Tags (common)
        run: curl -L "$CS2_TAGS" -o cs2-tags.zip

      - name: Extract CS2-Tags into CSS (Linux)
        run: unzip -q cs2-tags.zip -d "$OUT_LINUX/addons/counterstrikesharp/"

      # --------------------- WINDOWS BUNDLE ---------------------
      - name: Download Metamod (Windows)
        run: curl -L "$METAMOD_URL_WINDOWS" -o mms_win.zip

      - name: Extract Metamod (Windows) into addons/metamod/
        run: unzip -q mms_win.zip -d "$OUT_WINDOWS"

      - name: Download CounterStrikeSharp (Windows)
        run: curl -L "$CSS_URL_WINDOWS" -o css_win.zip

      - name: Extract CounterStrikeSharp (Windows)
        run: unzip -q css_win.zip -d "$OUT_WINDOWS"

      - name: Download STFixes (Windows)
        run: curl -L "$STFIXES_WINDOWS" -o stfixes_win.zip

      - name: Extract STFixes (Windows)
        run: unzip -q stfixes_win.zip -d "$OUT_WINDOWS"

      - name: Download MovementUnlocker (Windows)
        run: curl -L "$MOVUNLOCKER_WINDOWS" -o mu_win.zip

      - name: Extract MovementUnlocker (Windows)
        run: unzip -q mu_win.zip -d "$OUT_WINDOWS"

      - name: Download RampBugFix (Windows)
        run: curl -L "$RAMPBUGFIX_WINDOWS" -o ramp_win.zip

      - name: Extract RampBugFix (Windows)
        run: unzip -q ramp_win.zip -d "$OUT_WINDOWS"

      - name: Extract CS2-Tags into CSS (Windows)
        run: unzip -q cs2-tags.zip -d "$OUT_WINDOWS/addons/counterstrikesharp/"

      # --------------------- POOR SHARP TIMER (build once) ---------------------
      - name: Set up .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Clone PoorSharpTimer (dev branch)
        run: |
          git clone --depth 1 --branch "$PST_BRANCH" "$PST_REPO" pst
          echo "PST_COMMIT=$(git -C pst rev-parse --short HEAD)" >> "$GITHUB_ENV"

      - name: Build PoorSharpTimer
        run: |
          cd pst
          dotnet build
          cd -

      - name: Place PoorSharpTimer into both bundles
        run: |
          for OUT in "$OUT_LINUX" "$OUT_WINDOWS"; do
            rsync -avrt pst/Build/ "$OUT/"
          done

      # --------------------- LOG & PACKAGE ---------------------
      - name: Show resulting structures
        run: |
          echo "=== LINUX ==="
          find "$OUT_LINUX" -maxdepth 3 -type d -print
          echo "=== WINDOWS ==="
          find "$OUT_WINDOWS" -maxdepth 3 -type d -print

      - name: Create distributable zips
        run: |
          (cd "$OUT_LINUX" && zip -r "../$ZIP_LINUX" *)
          (cd "$OUT_WINDOWS" && zip -r "../$ZIP_WINDOWS" *)

      - name: Upload artifacts (CI)
        uses: actions/upload-artifact@v4
        with:
          name: bundles
          path: |
            ${{ env.ZIP_LINUX }}
            ${{ env.ZIP_WINDOWS }}

      - name: Create Git tag
        id: tagger
        run: |
          TAG="bundle-${GITHUB_RUN_NUMBER}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tagger.outputs.tag }}
          name: CS2 Drop-in Bundles ${{ steps.tagger.outputs.tag }}
          body: |
            Automated bundle build.
            PoorSharpTimer: branch `${{ env.PST_BRANCH }}`, commit ${{ env.PST_COMMIT }}

            **Linux sources**
            - Metamod: ${{ env.METAMOD_URL_LINUX }}
            - CounterStrikeSharp: ${{ env.CSS_URL_LINUX }}
            - STFixes: ${{ env.STFIXES_LINUX }}
            - MovementUnlocker: ${{ env.MOVUNLOCKER_LINUX }}
            - RampBugFix: ${{ env.RAMPBUGFIX_LINUX }}

            **Windows sources**
            - Metamod: ${{ env.METAMOD_URL_WINDOWS }}
            - CounterStrikeSharp: ${{ env.CSS_URL_WINDOWS }}
            - STFixes: ${{ env.STFIXES_WINDOWS }}
            - MovementUnlocker: ${{ env.MOVUNLOCKER_WINDOWS }}
            - RampBugFix: ${{ env.RAMPBUGFIX_WINDOWS }}

            **Common**
            - CS2-Tags: ${{ env.CS2_TAGS }}

            **Structure inside each zip**
            addons/
              metamod/
              counterstrikesharp/
                plugins/poor-sharptimer/
          files: |
            ${{ env.ZIP_LINUX }}
            ${{ env.ZIP_WINDOWS }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
